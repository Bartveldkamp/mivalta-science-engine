{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "mivalta:llm_intent",
  "title": "LLMIntent",
  "description": "Required output schema for Josi LLM responses. Validated by engine before delivery to user.",
  "type": "object",
  "additionalProperties": false,
  "required": ["intent", "response_type", "message", "source_cards", "guardrail_triggered"],
  "properties": {
    "intent": {
      "type": "string",
      "enum": ["question", "replan", "encouragement", "feedback", "compliance", "general", "blocked", "medical_red_flag"],
      "description": "Classified intent from user message"
    },
    "response_type": {
      "type": "string",
      "enum": [
        "DailyBrief",
        "ExplainWorkout",
        "ExplainZone",
        "WeeklyReview",
        "Encouragement",
        "SafetyWarning",
        "ReadinessSummary",
        "QuestionAnswer",
        "Decline"
      ],
      "description": "Response type determines validation rules and UI rendering"
    },
    "message": {
      "type": "string",
      "minLength": 1,
      "description": "The actual response text to display to the user"
    },
    "source_cards": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "enum": [
          "advisor_policy",
          "energy_systems",
          "fatigue_policy",
          "feasibility_policy",
          "goal_demands",
          "insight_rules_v1",
          "josi_explanations",
          "josi_personas_v1",
          "load_monitoring",
          "meso_dance_policy",
          "modifiers",
          "modifiers_cycling",
          "modifiers_running",
          "monitoring_v5",
          "monotony_policy",
          "operational",
          "pack_composition",
          "periodization",
          "session_rules",
          "session_variety_policy",
          "training_load_model",
          "zone_anchors",
          "zone_physiology"
        ]
      },
      "description": "Knowledge cards that informed this response. Must reference actual cards only."
    },
    "replan_request": {
      "oneOf": [
        { "type": "null" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "reason", "mode", "readiness_at_request"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["skip_today", "swap_days", "reschedule", "reduce_intensity", "illness", "travel", "goal_change"]
            },
            "reason": { "type": "string", "minLength": 1 },
            "mode": { "type": "string", "enum": ["coach"] },
            "readiness_at_request": { "type": "string", "enum": ["Green", "Yellow", "Orange", "Red"] },
            "new_goal_date": {
              "type": "string",
              "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$",
              "description": "Only for goal_change type"
            }
          }
        }
      ],
      "description": "Non-null only for coach-tier replan intents"
    },
    "tool_call": {
      "oneOf": [
        { "type": "null" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["tool", "args"],
          "properties": {
            "tool": {
              "type": "string",
              "enum": [
                "get_user_status",
                "explain_workout",
                "create_today_workout",
                "create_plan",
                "replan",
                "log_workout",
                "get_recent_workouts"
              ]
            },
            "args": {
              "type": "object",
              "additionalProperties": true
            }
          }
        }
      ],
      "description": "Optional tool routing. null when response is pure explanation."
    },
    "guardrail_triggered": {
      "type": "boolean",
      "description": "True if any I6 guardrail fired during response generation"
    },
    "guardrail_reason": {
      "type": ["string", "null"],
      "description": "Specific guardrail violation code if triggered"
    }
  }
}
